<?xml version="1.0" encoding="UTF-8"?>
<task_packages>
    <task_package>
        <metadata>
            <id>HEALIO-046</id>
            <title>Implement Stripe Checkout Service and Invoice Pay-Link Endpoint</title>
            <domain>Payments Integration</domain>
            <estimated_time>45 mins</estimated_time>
            <priority>high</priority>
            <status>DONE</status>
            <is_done>true</is_done>
            <verification_status>PASSED</verification_status>
            <dependencies>HEALIO-043, HEALIO-045</dependencies>
            <prd_reference>Feature 4 Stripe Integration + pay-link endpoint</prd_reference>
        </metadata>
        <context>
            <background>This task implements Implement Stripe Checkout Service and Invoice Pay-Link Endpoint for Healio and is scoped as one atomic work item aligned to the PRD. It should be completed within 45 mins and leave clear evidence for follow-on tasks.</background>
            <files_involved>
                <file>healio/lib/stripe.ts</file>
                <file>healio/services/stripeService.ts</file>
                <file>healio/app/api/v1/invoices/[id]/pay-link/route.ts</file>
            </files_involved>
            <related_api_endpoints>
                <endpoint>POST /api/v1/invoices/:id/pay-link</endpoint>
            </related_api_endpoints>
            <design_constraints>
                <constraint>Follow the PRD architecture/security conventions and keep outputs compatible with the Healio design system and response envelopes.</constraint>
            </design_constraints>
        </context>
        <instruction>
            <step>Implement the scoped changes for Implement Stripe Checkout Service and Invoice Pay-Link Endpoint in the planned files (healio/lib/stripe.ts, healio/services/stripeService.ts, healio/app/api/v1/invoices/[id]/pay-link/route.ts) while preserving the PRD-aligned project structure.</step>
            <step>Apply validation, error handling, and consistent response/UI behavior so the task output integrates cleanly with existing helpers and patterns.</step>
            <step>Wire integrations and dependencies for this task (endpoints: POST /api/v1/invoices/:id/pay-link) and keep tenant scoping/RBAC/security expectations intact where applicable.</step>
            <step>Add or update focused tests (unit/integration) for critical business rules, idempotency, or security behavior introduced by this task.</step>
            <step>Document assumptions and any follow-on schema/API contracts in code comments or lightweight docs when they affect downstream tasks.</step>
            <validation_checklist>
                <check>Exercise the related endpoint(s): POST /api/v1/invoices/:id/pay-link and verify response shape/status codes.</check>
                <check>Run lint/typecheck or the smallest relevant test suite for the files changed by this task.</check>
                <check>Validate security/tenant behavior with at least one negative test or rejection scenario when applicable.</check>
                <check>Record evidence of persistence/side effects (DB row change, log entry, webhook event handling, cache behavior, etc.) as applicable.</check>
            </validation_checklist>
        </instruction>
        <output_spec>
            <artifacts>
                <artifact>Next.js page/component updates</artifact>
                <artifact>Route handler/API contract updates</artifact>
                <artifact>Service-layer business logic updates</artifact>
            </artifacts>
            <acceptance_criteria>
                <criterion>The deliverable for Implement Stripe Checkout Service and Invoice Pay-Link Endpoint is implemented in the referenced files and compiles without breaking adjacent modules.</criterion>
                <criterion>Task output matches the PRD scope (Feature 4 Stripe Integration + pay-link endpoint) and remains bounded to an atomic &lt;=45-minute implementation chunk.</criterion>
                <criterion>Related endpoint behavior returns the standard success/error envelope and respects auth/public route expectations for the route class.</criterion>
                <criterion>Business rules, tenant scoping, and security constraints relevant to this task are enforced (validation, idempotency, RBAC, webhook/cron protection, etc.).</criterion>
                <criterion>At least one verification artifact (test case, curl call, or fixture-driven check) proves the new behavior works and regressions are covered.</criterion>
            </acceptance_criteria>
            <commit_message>feat(healio-billing): stripe checkout and pay link route</commit_message>
        </output_spec>
        <execution_tracking>
            <state>DONE</state>
            <is_done>true</is_done>
            <owner>billing-invoicing-payments</owner>
            <started_at>2026-02-24T18:50:40+08:00</started_at>
            <completed_at>2026-02-24T18:50:40+08:00</completed_at>
            <verification_status>PASSED</verification_status>
            <verification_command>npm run typecheck; node --import tsx --test tests/unit/invoice-pay-link-route.test.ts</verification_command>
            <verification_notes>Implemented a Stripe checkout abstraction (`lib/stripe.ts`) with runtime lazy import and a safe local/test fallback, plus `stripeService.ts` for invoice pay-link creation and `POST /api/v1/invoices/:id/pay-link`. The route persists the generated checkout URL on the invoice, marks draft invoices as sent, and enforces tenant/invoice-payable rules.</verification_notes>
            <evidence>
                <item>When work starts/completes, record changed files, test commands, screenshots (UI tasks), and commit/PR references here.</item>
                <item>Changed files: healio/lib/stripe.ts, healio/services/stripeService.ts, healio/app/api/v1/invoices/[id]/pay-link/route.ts, healio/services/invoiceService.ts, healio/tests/unit/invoice-pay-link-route.test.ts, healio/tsconfig.tsbuildinfo.</item>
                <item>`lib/stripe.ts` now exposes `createStripeCheckoutSession` with a runtime lazy `stripe` import (no compile-time dependency required) and a deterministic local fallback checkout URL/session id for tests/dev when `STRIPE_SECRET_KEY` is absent.</item>
                <item>`services/stripeService.ts` validates invoice payable state (not void/refunded/already paid), computes remaining balance cents, builds success/cancel URLs, calls the Stripe abstraction, and persists the generated checkout URL on the invoice via `setInvoiceStripeCheckoutLinkForClinic`.</item>
                <item>`POST /api/v1/invoices/:id/pay-link` is tenant-protected, validates invoice id, returns standard success/error envelopes, and logs provider/session metadata.</item>
                <item>Typecheck: `npm run typecheck` passed after replacing the direct dynamic import with a runtime-only lazy import (`eval(import('stripe'))`) fallback shim.</item>
                <item>Route tests: `node --import tsx --test tests/unit/invoice-pay-link-route.test.ts` passed (fallback pay link generation, invoice persistence/status update, invalid id, unauthenticated, tenant mismatch, and already-paid rejection).</item>
                <item>Implementation commit: 2e8df3f (feat(healio-billing): stripe checkout and pay link route).</item>
            </evidence>
            <completion_signal>Task is done only when state=DONE, is_done=true, completed_at is filled, verification_status=PASSED, and evidence records changed files/tests/screenshots as applicable.</completion_signal>
        </execution_tracking>
        <references>
            <agent_to_execute>Full-Stack Next.js Engineer</agent_to_execute>
            <estimated_complexity>medium</estimated_complexity>
            <blocks_on>HEALIO-043, HEALIO-045</blocks_on>
            <task_slug>STRIPE_CHECKOUT_AND_PAY_LINK_ROUTE</task_slug>
        </references>
    </task_package>
</task_packages>
