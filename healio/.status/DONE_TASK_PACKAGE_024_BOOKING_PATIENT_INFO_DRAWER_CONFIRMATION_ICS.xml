<?xml version='1.0' encoding='utf-8'?>
<task_packages>
    <task_package>
        <metadata>
            <id>HEALIO-024</id>
            <title>Add Patient Info Drawer, Booking Submission, Confirmation Screen, and ICS Export</title>
            <domain>Public Booking Frontend</domain>
            <estimated_time>45 mins</estimated_time>
            <priority>high</priority>
            <status>DONE</status>
            <is_done>true</is_done>
            <verification_status>PASSED</verification_status>
            <dependencies>HEALIO-022, HEALIO-023</dependencies>
            <prd_reference>Feature 1 Patient Info Form + Confirmation Screen</prd_reference>
        </metadata>
        <context>
            <background>This task implements Add Patient Info Drawer, Booking Submission, Confirmation Screen, and ICS Export for Healio and is scoped as one atomic work item aligned to the PRD. It should be completed within 45 mins and leave clear evidence for follow-on tasks.</background>
            <files_involved>
                <file>healio/components/appointments/public-booking-patient-form.tsx</file>
                <file>healio/components/appointments/public-booking-confirmation.tsx</file>
                <file>healio/lib/ics.ts</file>
                <file>healio/app/(public)/book/[slug]/page.tsx</file>
            </files_involved>
            <related_api_endpoints>
                <endpoint>POST /api/v1/public/bookings</endpoint>
            </related_api_endpoints>
            <design_constraints>
                <constraint>Use Stripe-like frictionless workflows: create/edit actions should open centered modals or slide-out drawers instead of disruptive full-page forms.</constraint>
                <constraint>Use a Viedoc-style bento layout: soft floating white cards on an off-white background for dashboards and dense data views.</constraint>
                <constraint>Apply the Paper Replacement palette: app background near #F9FAFB, white cards, calm trustworthy accents (teal/sage/cerulean), and reserve red for critical alerts only.</constraint>
                <constraint>Preserve high-legibility typography: clean sans-serif (Inter/SF Pro/Halyard), bold patient names, slate-gray secondary metadata.</constraint>
                <constraint>Honor the one-click rule where applicable: keep the global + action for Add Appointment, Add Patient, and Create Invoice visible and easy to reach.</constraint>
                <constraint>Add educational empty states with clear CTAs for first-time or empty datasets.</constraint>
            </design_constraints>
        </context>
        <instruction>
            <step>Implement the scoped changes for Add Patient Info Drawer, Booking Submission, Confirmation Screen, and ICS Export in the planned files (healio/components/appointments/public-booking-patient-form.tsx, healio/components/appointments/public-booking-confirmation.tsx, healio/lib/ics.ts, healio/app/(public)/book/[slug]/page.tsx) while preserving the PRD-aligned project structure.</step>
            <step>Apply validation, error handling, and consistent response/UI behavior so the task output integrates cleanly with existing helpers and patterns.</step>
            <step>Wire integrations and dependencies for this task (endpoints: POST /api/v1/public/bookings) and keep tenant scoping/RBAC/security expectations intact where applicable.</step>
            <step>Prefer in-context modal/drawer workflows, scannable bento cards, and educational empty states so the UI matches the requested Healio experience.</step>
            <step>Verify keyboard/focus behavior, touch target sizing, and mobile responsiveness before marking the task ready.</step>
            <validation_checklist>
                <check>Exercise the related endpoint(s): POST /api/v1/public/bookings and verify response shape/status codes.</check>
                <check>Run lint/typecheck or the smallest relevant test suite for the files changed by this task.</check>
                <check>Manually verify desktop and mobile layouts plus focus/keyboard behavior for the primary interaction path.</check>
                <check>Use Chrome DevTools MCP to verify the implemented UI in-browser (desktop + mobile), check interactions, inspect console errors, and capture a validation snapshot before marking done.</check>
                <check>Capture a screenshot or short note confirming empty/loading/error states are present where applicable.</check>
            </validation_checklist>
        </instruction>
        <output_spec>
            <artifacts>
                <artifact>Next.js page/component updates</artifact>
                <artifact>Route handler/API contract updates</artifact>
            </artifacts>
            <acceptance_criteria>
                <criterion>The deliverable for Add Patient Info Drawer, Booking Submission, Confirmation Screen, and ICS Export is implemented in the referenced files and compiles without breaking adjacent modules.</criterion>
                <criterion>Task output matches the PRD scope (Feature 1 Patient Info Form + Confirmation Screen) and remains bounded to an atomic &lt;=45-minute implementation chunk.</criterion>
                <criterion>Related endpoint behavior returns the standard success/error envelope and respects auth/public route expectations for the route class.</criterion>
                <criterion>UI states (loading, empty, error, success) are present and visually consistent with Healio bento cards, off-white background, and trust-oriented styling.</criterion>
                <criterion>Interactions are keyboard accessible and usable on mobile without disruptive navigation when a modal/drawer workflow is appropriate.</criterion>
            </acceptance_criteria>
            <commit_message>feat(healio-booking): booking patient info drawer confirmation ics</commit_message>
        </output_spec>
        <execution_tracking>
            <state>DONE</state>
            <is_done>true</is_done>
            <owner>public-booking</owner>
            <started_at>2026-02-24T17:15:04+08:00</started_at>
            <completed_at>2026-02-24T17:15:04+08:00</completed_at>
            <verification_status>PASSED</verification_status>
            <verification_command>npm run typecheck; Chrome DevTools MCP /book/northview-clinic drawer flow: open patient drawer, fill form, POST /api/v1/public/bookings (reqid=308 429 error-state + reqid=309 201 success retry), confirmation snapshot, .ics download button click, mobile resize 390x844</verification_command>
            <verification_notes>Added a Stripe-style patient info drawer, booking submission flow to POST /api/v1/public/bookings, confirmation card, toast feedback, and client-side ICS export. Verified both error and success submission paths in Chrome DevTools MCP. First submission hit the intended public API rate limiter (429) and rendered inline/toast errors; after cooldown, retry succeeded (201) and displayed the confirmation UI with booking identifiers and .ics download action.</verification_notes>
            <evidence>
                <item>When work starts/completes, record changed files, test commands, screenshots (UI tasks), and commit/PR references here.</item>
                <item>Include Chrome DevTools MCP evidence (snapshot/screenshot reference and notes on responsive + interaction checks) here before marking frontend tasks complete.</item>
                <item>Changed files: healio/components/appointments/public-booking-patient-form.tsx, healio/components/appointments/public-booking-confirmation.tsx, healio/lib/ics.ts, healio/app/(public)/book/[slug]/page.tsx.</item>
                <item>Typecheck: `npm run typecheck` passed.</item>
                <item>Chrome DevTools MCP drawer interaction: selected slot (`uid=46_42`), clicked Continue (`uid=46_94`) and confirmed `dialog "Patient details"` opened with drawer form fields (`uid=48_13`..`uid=48_21`).</item>
                <item>Chrome DevTools MCP form fill: `fill_form` populated first/last/email/phone/notes fields and drawer summary reflected selected clinic/service/slot.</item>
                <item>POST error-state verification (reqid=308): first `POST /api/v1/public/bookings` returned 429 `RATE_LIMITED`; drawer displayed inline error card (snapshot `uid=50_0`/`uid=50_1`) and error toast (`uid=50_3`/`uid=50_4`).</item>
                <item>POST success verification (reqid=309): retry after cooldown returned 201 with standard success envelope, booking/appointment IDs, and `x-idempotency-key` header (see `get_network_request reqid=309`).</item>
                <item>Confirmation UI verification: Chrome DevTools MCP waited for "Appointment confirmed" and snapshot showed confirmation card (`uid=52_0`) with patient name, IDs, status, and action buttons.</item>
                <item>ICS export verification: clicked `Download .ics` button (`uid=52_18`); no extra network request was created because ICS is generated client-side via Blob download (`healio/lib/ics.ts`).</item>
                <item>Mobile verification: resized viewport to 390x844 and captured confirmation-state snapshot (same root `uid=38_0`) showing stacked mobile layout and reachable confirmation actions.</item>
                <item>Console review: preserved console messages include Fast Refresh logs plus one expected 429 resource error from the intentional rate-limit validation; no unexpected runtime exceptions observed during the successful retry path.</item>
                <item>Implementation commit: 5653ed2 (feat(healio-booking): booking patient info drawer confirmation ics).</item>
            </evidence>
            <completion_signal>Task is done only when state=DONE, is_done=true, completed_at is filled, verification_status=PASSED, and evidence records changed files/tests/screenshots as applicable.</completion_signal>
        </execution_tracking>
        <references>
            <agent_to_execute>Full-Stack Next.js Engineer</agent_to_execute>
            <estimated_complexity>medium</estimated_complexity>
            <blocks_on>HEALIO-022, HEALIO-023</blocks_on>
            <task_slug>BOOKING_PATIENT_INFO_DRAWER_CONFIRMATION_ICS</task_slug>
            <verification_tool>Chrome DevTools MCP (required for frontend task verification)</verification_tool>
            <verification_rules_ref>healio/.status/FRONTEND_VERIFICATION_RULES.xml</verification_rules_ref>
        </references>
    </task_package>
</task_packages>