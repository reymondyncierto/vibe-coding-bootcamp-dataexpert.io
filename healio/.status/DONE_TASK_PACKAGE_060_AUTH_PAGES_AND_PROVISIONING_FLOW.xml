<?xml version='1.0' encoding='utf-8'?>
<task_packages>
    <task_package>
        <metadata>
            <id>HEALIO-060</id>
            <title>Build Login/Signup Pages and Post-Signup Clinic Provisioning Flow</title>
            <domain>Authentication Frontend &amp; Backend</domain>
            <estimated_time>45 mins</estimated_time>
            <priority>high</priority>
            <status>DONE</status>
            <is_done>true</is_done>
            <verification_status>PASSED</verification_status>
            <dependencies>HEALIO-014, HEALIO-015, HEALIO-056</dependencies>
            <prd_reference>Feature 7 Auth Flows</prd_reference>
        </metadata>
        <context>
            <background>This task implements Build Login/Signup Pages and Post-Signup Clinic Provisioning Flow for Healio and is scoped as one atomic work item aligned to the PRD. It should be completed within 45 mins and leave clear evidence for follow-on tasks.</background>
            <files_involved>
                <file>healio/app/(auth)/login/page.tsx</file>
                <file>healio/app/(auth)/signup/page.tsx</file>
                <file>healio/app/api/auth/provision/route.ts</file>
                <file>healio/services/authProvisioningService.ts</file>
            </files_involved>
            <related_api_endpoints>
                <endpoint>Supabase OAuth/magic-link callback</endpoint>
                <endpoint>POST /api/auth/provision</endpoint>
            </related_api_endpoints>
            <design_constraints>
                <constraint>Use Stripe-like frictionless workflows: create/edit actions should open centered modals or slide-out drawers instead of disruptive full-page forms.</constraint>
                <constraint>Use a Viedoc-style bento layout: soft floating white cards on an off-white background for dashboards and dense data views.</constraint>
                <constraint>Apply the Paper Replacement palette: app background near #F9FAFB, white cards, calm trustworthy accents (teal/sage/cerulean), and reserve red for critical alerts only.</constraint>
                <constraint>Preserve high-legibility typography: clean sans-serif (Inter/SF Pro/Halyard), bold patient names, slate-gray secondary metadata.</constraint>
                <constraint>Honor the one-click rule where applicable: keep the global + action for Add Appointment, Add Patient, and Create Invoice visible and easy to reach.</constraint>
                <constraint>Add educational empty states with clear CTAs for first-time or empty datasets.</constraint>
            </design_constraints>
        </context>
        <instruction>
            <step>Implement the scoped changes for Build Login/Signup Pages and Post-Signup Clinic Provisioning Flow in the planned files (healio/app/(auth)/login/page.tsx, healio/app/(auth)/signup/page.tsx, healio/app/api/auth/provision/route.ts, healio/services/authProvisioningService.ts) while preserving the PRD-aligned project structure.</step>
            <step>Apply validation, error handling, and consistent response/UI behavior so the task output integrates cleanly with existing helpers and patterns.</step>
            <step>Wire integrations and dependencies for this task (endpoints: Supabase OAuth/magic-link callback, POST /api/auth/provision) and keep tenant scoping/RBAC/security expectations intact where applicable.</step>
            <step>Prefer in-context modal/drawer workflows, scannable bento cards, and educational empty states so the UI matches the requested Healio experience.</step>
            <step>Verify keyboard/focus behavior, touch target sizing, and mobile responsiveness before marking the task ready.</step>
            <validation_checklist>
                <check>Exercise the related endpoint(s): Supabase OAuth/magic-link callback, POST /api/auth/provision and verify response shape/status codes.</check>
                <check>Run lint/typecheck or the smallest relevant test suite for the files changed by this task.</check>
                <check>Manually verify desktop and mobile layouts plus focus/keyboard behavior for the primary interaction path.</check>
                <check>Use Chrome DevTools MCP to verify the implemented UI in-browser (desktop + mobile), check interactions, inspect console errors, and capture a validation snapshot before marking done.</check><check>Capture a screenshot or short note confirming empty/loading/error states are present where applicable.</check>
            </validation_checklist>
        </instruction>
        <output_spec>
            <artifacts>
                <artifact>Next.js page/component updates</artifact>
                <artifact>Route handler/API contract updates</artifact>
                <artifact>Service-layer business logic updates</artifact>
            </artifacts>
            <acceptance_criteria>
                <criterion>The deliverable for Build Login/Signup Pages and Post-Signup Clinic Provisioning Flow is implemented in the referenced files and compiles without breaking adjacent modules.</criterion>
                <criterion>Task output matches the PRD scope (Feature 7 Auth Flows) and remains bounded to an atomic &lt;=45-minute implementation chunk.</criterion>
                <criterion>Related endpoint behavior returns the standard success/error envelope and respects auth/public route expectations for the route class.</criterion>
                <criterion>UI states (loading, empty, error, success) are present and visually consistent with Healio bento cards, off-white background, and trust-oriented styling.</criterion>
                <criterion>Interactions are keyboard accessible and usable on mobile without disruptive navigation when a modal/drawer workflow is appropriate.</criterion>
            </acceptance_criteria>
            <commit_message>feat(healio-auth): auth pages and provisioning flow</commit_message>
        </output_spec>
        <execution_tracking>
            <state>DONE</state>
            <is_done>true</is_done>
            <owner>auth-rbac-security</owner>
            <started_at>2026-02-24T23:15:07+08:00</started_at>
            <completed_at>2026-02-24T23:15:07+08:00</completed_at>
            <verification_status>PASSED</verification_status>
            <verification_command>npm run typecheck; node --import tsx --test tests/unit/auth-provision-route.test.ts; Chrome DevTools MCP on /login, /signup, /auth/callback</verification_command>
            <verification_notes>Implemented bento-style login/signup pages with Supabase magic-link/OAuth hooks plus local-safe fallback provisioning preview, a replay-safe `POST /api/auth/provision` route/service that initializes clinic settings, and `/auth/callback` code/error redirect handling. Chrome DevTools MCP validation also caught and confirmed fixes for client `server-only` import bundling (`lib/supabase/client.ts`) and missing `autocomplete` attributes on auth form inputs.</verification_notes>
            <evidence>
                <item>When work starts/completes, record changed files, test commands, screenshots (UI tasks), and commit/PR references here.</item>
                <item>Changed files: healio/app/(auth)/login/page.tsx, healio/app/(auth)/signup/page.tsx, healio/app/auth/login/page.tsx, healio/app/auth/signup/page.tsx, healio/app/auth/callback/route.ts, healio/app/api/auth/provision/route.ts, healio/services/authProvisioningService.ts, healio/services/clinicService.ts, healio/lib/supabase/client.ts, healio/tests/unit/auth-provision-route.test.ts.</item>
                <item>Provisioning API verification (unit test): `tests/unit/auth-provision-route.test.ts` confirms `POST /api/auth/provision` returns `201` on first provision and `200` on replay, with updated clinic name replay behavior and payload validation `400`.</item>
                <item>Chrome DevTools MCP login page (`/login`): desktop render verified (`uid 17_*`), local provisioning preview button exercised successfully, and onboarding handoff link surfaced.</item>
                <item>Chrome DevTools MCP signup page (`/signup`): desktop + mobile (390x844) render verified (`uid 20_*`, `24_*`), submit action produced provisioning success then replay success state (`uid 21_*`, `25_*`).</item>
                <item>Chrome DevTools MCP network evidence: `POST /api/auth/provision` observed with `201` (reqid=206) and replay `200` (reqid=235); `GET /auth/callback?...` observed `307` redirect (reqid=207) to `/auth/login?...` `200` (reqid=208).</item>
                <item>Chrome DevTools MCP callback UI verification: navigating to `/auth/callback?error=access_denied&amp;next=%2Fsettings` redirected to `/auth/login?...` and displayed callback error banner (`uid 23_*`).</item>
                <item>Chrome DevTools MCP console check passed after final patch: `list_console_messages` returned no console messages (autocomplete warning removed by adding `autoComplete` attrs).</item>
                <item>Quality fix found during verification: replaced `server-only` env import in `healio/lib/supabase/client.ts` with browser-safe `NEXT_PUBLIC_*` env reads to prevent client bundle compile failure on auth pages.</item>
                <item>Typecheck/tests passed: `npm run typecheck`; `node --import tsx --test tests/unit/auth-provision-route.test.ts`.</item>
                <item>Feature commit: 1061b2c (feat(healio-auth): auth pages and provisioning flow).</item>
                <item>Include Chrome DevTools MCP evidence (snapshot/screenshot reference and notes on responsive + interaction checks) here before marking frontend tasks complete.</item>
            </evidence>
            <completion_signal>Task is done only when state=DONE, is_done=true, completed_at is filled, verification_status=PASSED, and evidence records changed files/tests/screenshots as applicable.</completion_signal>
        </execution_tracking>
        <references>
            <agent_to_execute>Full-Stack Next.js Engineer</agent_to_execute>
            <estimated_complexity>medium</estimated_complexity>
            <blocks_on>HEALIO-014, HEALIO-015, HEALIO-056</blocks_on>
            <task_slug>AUTH_PAGES_AND_PROVISIONING_FLOW</task_slug>
        <verification_tool>Chrome DevTools MCP (required for frontend task verification)</verification_tool><verification_rules_ref>healio/.status/FRONTEND_VERIFICATION_RULES.xml</verification_rules_ref></references>
    </task_package>
</task_packages>
