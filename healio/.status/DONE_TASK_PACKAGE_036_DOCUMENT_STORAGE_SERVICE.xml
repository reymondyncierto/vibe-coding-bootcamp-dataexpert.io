<?xml version="1.0" encoding="UTF-8"?>
<task_packages>
    <task_package>
        <metadata>
            <id>HEALIO-036</id>
            <title>Build Document Storage Service with File Validation and Private Access</title>
            <domain>Patient Documents Backend</domain>
            <estimated_time>45 mins</estimated_time>
            <priority>high</priority>
            <status>DONE</status>
            <is_done>true</is_done>
            <verification_status>PASSED</verification_status>
            <dependencies>HEALIO-003, HEALIO-014, HEALIO-016</dependencies>
            <prd_reference>Feature 3 Documents Tab; 4.4 File Upload Security</prd_reference>
        </metadata>
        <context>
            <background>This task implements Build Document Storage Service with File Validation and Private Access for Healio and is scoped as one atomic work item aligned to the PRD. It should be completed within 45 mins and leave clear evidence for follow-on tasks.</background>
            <files_involved>
                <file>healio/services/documentService.ts</file>
                <file>healio/lib/supabase/server.ts</file>
                <file>healio/lib/utils.ts</file>
                <file>healio/tests/unit/document-validation.test.ts</file>
            </files_involved>
            <related_api_endpoints>
                <endpoint>none</endpoint>
            </related_api_endpoints>
            <design_constraints>
                <constraint>Follow the PRD architecture/security conventions and keep outputs compatible with the Healio design system and response envelopes.</constraint>
            </design_constraints>
        </context>
        <instruction>
            <step>Implement the scoped changes for Build Document Storage Service with File Validation and Private Access in the planned files (healio/services/documentService.ts, healio/lib/supabase/server.ts, healio/lib/utils.ts, healio/tests/unit/document-validation.test.ts) while preserving the PRD-aligned project structure.</step>
            <step>Apply validation, error handling, and consistent response/UI behavior so the task output integrates cleanly with existing helpers and patterns.</step>
            <step>Wire integrations and dependencies for this task (endpoints: none) and keep tenant scoping/RBAC/security expectations intact where applicable.</step>
            <step>Add or update focused tests (unit/integration) for critical business rules, idempotency, or security behavior introduced by this task.</step>
            <step>Document assumptions and any follow-on schema/API contracts in code comments or lightweight docs when they affect downstream tasks.</step>
            <validation_checklist>
                <check>Run lint/typecheck or the smallest relevant test suite for the files changed by this task.</check>
                <check>Validate security/tenant behavior with at least one negative test or rejection scenario when applicable.</check>
                <check>Record evidence of persistence/side effects (DB row change, log entry, webhook event handling, cache behavior, etc.) as applicable.</check>
            </validation_checklist>
        </instruction>
        <output_spec>
            <artifacts>
                <artifact>Service-layer business logic updates</artifact>
                <artifact>Verification tests or fixtures</artifact>
            </artifacts>
            <acceptance_criteria>
                <criterion>The deliverable for Build Document Storage Service with File Validation and Private Access is implemented in the referenced files and compiles without breaking adjacent modules.</criterion>
                <criterion>Task output matches the PRD scope (Feature 3 Documents Tab; 4.4 File Upload Security) and remains bounded to an atomic &lt;=45-minute implementation chunk.</criterion>
                <criterion>Business rules, tenant scoping, and security constraints relevant to this task are enforced (validation, idempotency, RBAC, webhook/cron protection, etc.).</criterion>
                <criterion>At least one verification artifact (test case, curl call, or fixture-driven check) proves the new behavior works and regressions are covered.</criterion>
            </acceptance_criteria>
            <commit_message>feat(healio-patients): document storage service</commit_message>
        </output_spec>
        <execution_tracking>
            <state>DONE</state>
            <is_done>true</is_done>
            <owner>patient-documents-storage</owner>
            <started_at>2026-02-24T18:08:13+08:00</started_at>
            <completed_at>2026-02-24T18:08:13+08:00</completed_at>
            <verification_status>PASSED</verification_status>
            <verification_command>npm run typecheck; node --import tsx --test tests/unit/document-validation.test.ts</verification_command>
            <verification_notes>Built a document storage service with strict file validation (MIME allowlist, 10MB cap, magic-byte signature checks), UUID-based private object paths, filename sanitization, and signed private URL generation. Added a Supabase service-role client helper in `lib/supabase/server.ts` and a lazy-loaded storage adapter with in-memory fallback so local/test flows work without env secrets. Also added reusable metadata/list/sign helpers in documentService to support the upcoming patient documents API route task.</verification_notes>
            <evidence>
                <item>When work starts/completes, record changed files, test commands, screenshots (UI tasks), and commit/PR references here.</item>
                <item>Changed files: healio/services/documentService.ts, healio/lib/supabase/server.ts, healio/lib/utils.ts, healio/tests/unit/document-validation.test.ts, plus generated healio/tsconfig.tsbuildinfo.</item>
                <item>Typecheck: `npm run typecheck` passed.</item>
                <item>Validation tests: `node --import tsx --test tests/unit/document-validation.test.ts` passed; verifies allowed MIME types + magic bytes, oversized/unsupported/mismatch rejection, filename sanitization, private object path generation, and signed URL generation via in-memory private storage fallback.</item>
                <item>Security constraints enforced: only `application/pdf`, `image/jpeg`, `image/png`; max size 10MB; content-sniffing via magic bytes; sanitized UUID-based object paths; signed download URLs (default 1-hour expiry).</item>
                <item>Implementation commit: 3b8ecf5 (feat(healio-patients): document storage service).</item>
            </evidence>
            <completion_signal>Task is done only when state=DONE, is_done=true, completed_at is filled, verification_status=PASSED, and evidence records changed files/tests/screenshots as applicable.</completion_signal>
        </execution_tracking>
        <references>
            <agent_to_execute>Full-Stack Next.js Engineer</agent_to_execute>
            <estimated_complexity>medium</estimated_complexity>
            <blocks_on>HEALIO-003, HEALIO-014, HEALIO-016</blocks_on>
            <task_slug>DOCUMENT_STORAGE_SERVICE</task_slug>
        </references>
    </task_package>
</task_packages>
