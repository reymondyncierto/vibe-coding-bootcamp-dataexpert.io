<?xml version="1.0" encoding="UTF-8"?>
<task_packages>
    <task_package>
        <metadata>
            <id>HEALIO-032</id>
            <title>Implement No-Show and Late-Cancel Tracking Logic with Tests</title>
            <domain>Appointments Backend</domain>
            <estimated_time>40 mins</estimated_time>
            <priority>medium</priority>
            <status>DONE</status>
            <is_done>true</is_done>
            <verification_status>PASSED</verification_status>
            <dependencies>HEALIO-025, HEALIO-027</dependencies>
            <prd_reference>Feature 2 Business Rules</prd_reference>
        </metadata>
        <context>
            <background>This task implements Implement No-Show and Late-Cancel Tracking Logic with Tests for Healio and is scoped as one atomic work item aligned to the PRD. It should be completed within 40 mins and leave clear evidence for follow-on tasks.</background>
            <files_involved>
                <file>healio/services/appointmentService.ts</file>
                <file>healio/services/patientService.ts</file>
                <file>healio/tests/unit/appointment-no-show.test.ts</file>
            </files_involved>
            <related_api_endpoints>
                <endpoint>PATCH /api/v1/appointments/:id</endpoint>
                <endpoint>DELETE /api/v1/appointments/:id</endpoint>
            </related_api_endpoints>
            <design_constraints>
                <constraint>Follow the PRD architecture/security conventions and keep outputs compatible with the Healio design system and response envelopes.</constraint>
            </design_constraints>
        </context>
        <instruction>
            <step>Implement the scoped changes for Implement No-Show and Late-Cancel Tracking Logic with Tests in the planned files (healio/services/appointmentService.ts, healio/services/patientService.ts, healio/tests/unit/appointment-no-show.test.ts) while preserving the PRD-aligned project structure.</step>
            <step>Apply validation, error handling, and consistent response/UI behavior so the task output integrates cleanly with existing helpers and patterns.</step>
            <step>Wire integrations and dependencies for this task (endpoints: PATCH /api/v1/appointments/:id, DELETE /api/v1/appointments/:id) and keep tenant scoping/RBAC/security expectations intact where applicable.</step>
            <step>Add or update focused tests (unit/integration) for critical business rules, idempotency, or security behavior introduced by this task.</step>
            <step>Document assumptions and any follow-on schema/API contracts in code comments or lightweight docs when they affect downstream tasks.</step>
            <validation_checklist>
                <check>Exercise the related endpoint(s): PATCH /api/v1/appointments/:id, DELETE /api/v1/appointments/:id and verify response shape/status codes.</check>
                <check>Run lint/typecheck or the smallest relevant test suite for the files changed by this task.</check>
                <check>Validate security/tenant behavior with at least one negative test or rejection scenario when applicable.</check>
                <check>Record evidence of persistence/side effects (DB row change, log entry, webhook event handling, cache behavior, etc.) as applicable.</check>
            </validation_checklist>
        </instruction>
        <output_spec>
            <artifacts>
                <artifact>Route handler/API contract updates</artifact>
                <artifact>Service-layer business logic updates</artifact>
                <artifact>Verification tests or fixtures</artifact>
            </artifacts>
            <acceptance_criteria>
                <criterion>The deliverable for Implement No-Show and Late-Cancel Tracking Logic with Tests is implemented in the referenced files and compiles without breaking adjacent modules.</criterion>
                <criterion>Task output matches the PRD scope (Feature 2 Business Rules) and remains bounded to an atomic &lt;=45-minute implementation chunk.</criterion>
                <criterion>Related endpoint behavior returns the standard success/error envelope and respects auth/public route expectations for the route class.</criterion>
                <criterion>Business rules, tenant scoping, and security constraints relevant to this task are enforced (validation, idempotency, RBAC, webhook/cron protection, etc.).</criterion>
                <criterion>At least one verification artifact (test case, curl call, or fixture-driven check) proves the new behavior works and regressions are covered.</criterion>
            </acceptance_criteria>
            <commit_message>feat(healio-appointments): no show and late cancel tracking</commit_message>
        </output_spec>
        <execution_tracking>
            <state>DONE</state>
            <is_done>true</is_done>
            <owner>appointments-operations</owner>
            <started_at>2026-02-24T17:54:24+08:00</started_at>
            <completed_at>2026-02-24T17:54:24+08:00</completed_at>
            <verification_status>PASSED</verification_status>
            <verification_command>npm run typecheck; node --import tsx --test tests/unit/appointment-no-show.test.ts; node --import tsx --test tests/unit/appointment-detail-route.test.ts</verification_command>
            <verification_notes>Added no-show and late-cancel tracking side effects in appointmentService for PATCH/DELETE flows and a lightweight patient attendance metrics store in patientService. Tracking is idempotent per appointment using internal flags (noShowTrackedAt/lateCancelTrackedAt) and uses a 24-hour late-cancel window. Included unit tests covering no-show increments, late-cancel window behavior, and delete-triggered late-cancel tracking, plus route-detail tests for endpoint PATCH/DELETE coverage.</verification_notes>
            <evidence>
                <item>When work starts/completes, record changed files, test commands, screenshots (UI tasks), and commit/PR references here.</item>
                <item>Changed files: healio/services/appointmentService.ts, healio/services/patientService.ts, healio/tests/unit/appointment-no-show.test.ts, plus generated healio/tsconfig.tsbuildinfo.</item>
                <item>Typecheck: `npm run typecheck` passed.</item>
                <item>No-show/late-cancel rule tests: `node --import tsx --test tests/unit/appointment-no-show.test.ts` passed; verifies (1) no-show counter increments once per appointment, (2) late-cancel counter increments only within 24h window, and (3) deleting a near-term appointment counts as late cancel.</item>
                <item>Endpoint coverage (PATCH/DELETE): `node --import tsx --test tests/unit/appointment-detail-route.test.ts` passed and exercised GET/PATCH/DELETE `/api/v1/appointments/:id` route behavior with success and validation/error cases.</item>
                <item>Side-effect persistence is recorded in patient attendance metrics store (`getPatientAttendanceMetrics`) keyed by clinicId+patientId; tests reset and assert counts/last event timestamps.</item>
                <item>Implementation commit: 54be207 (feat(healio-appointments): no show and late cancel tracking).</item>
            </evidence>
            <completion_signal>Task is done only when state=DONE, is_done=true, completed_at is filled, verification_status=PASSED, and evidence records changed files/tests/screenshots as applicable.</completion_signal>
        </execution_tracking>
        <references>
            <agent_to_execute>Full-Stack Next.js Engineer</agent_to_execute>
            <estimated_complexity>medium</estimated_complexity>
            <blocks_on>HEALIO-025, HEALIO-027</blocks_on>
            <task_slug>NO_SHOW_AND_LATE_CANCEL_TRACKING</task_slug>
        </references>
    </task_package>
</task_packages>
