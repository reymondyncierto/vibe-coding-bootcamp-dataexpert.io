generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Currency {
  USD
  PHP
}

enum SubscriptionTier {
  FREE
  STARTER
  CLINIC
  ENTERPRISE
}

enum StaffRole {
  OWNER
  DOCTOR
  RECEPTIONIST
}

enum PatientGender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum AppointmentStatus {
  SCHEDULED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  NO_SHOW
  CANCELLED
}

enum AppointmentSource {
  ONLINE
  PHONE
  WALK_IN
  STAFF
}

enum DocumentCategory {
  LAB_RESULT
  IMAGING
  REFERRAL
  PRESCRIPTION
  OTHER
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  VOID
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  GCASH
  MAYA
  STRIPE
}

enum NotificationType {
  BOOKING_CONFIRMATION
  REMINDER_24H
  REMINDER_1H
  NO_SHOW_FOLLOWUP
  INVOICE_SENT
  PAYMENT_CONFIRMATION
  FOLLOWUP_REMINDER
}

enum NotificationChannel {
  EMAIL
  SMS
}

enum NotificationStatus {
  SENT
  FAILED
  PENDING
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

model Clinic {
  id                   String           @id @default(uuid())
  name                 String
  slug                 String           @unique
  logo                 String?
  address              String?
  phone                String?
  email                String
  timezone             String           @default("Asia/Manila")
  currency             Currency         @default(USD)
  subscriptionTier     SubscriptionTier @default(FREE)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  deletedAt            DateTime?

  staff          Staff[]
  patients       Patient[]
  services       Service[]
  operatingHours OperatingHours[]
  appointments   Appointment[]
  visitNotes     VisitNote[]
  documents      Document[]
  invoices       Invoice[]
  notifications  Notification[]
  auditLogs      AuditLog[]
}

model Staff {
  id             String    @id @default(uuid())
  clinicId       String
  supabaseUserId String    @unique
  name           String
  email          String
  phone          String?
  role           StaffRole
  specialization String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  clinic       Clinic        @relation(fields: [clinicId], references: [id])
  appointments Appointment[] @relation("AppointmentStaff")
  visitNotes   VisitNote[]   @relation("VisitNoteStaff")
  documents    Document[]    @relation("DocumentStaff")
  auditLogs    AuditLog[]    @relation("AuditLogUser")

  @@index([clinicId])
}

model Patient {
  id                    String         @id @default(uuid())
  clinicId              String
  firstName             String
  lastName              String
  dateOfBirth           DateTime?
  gender                PatientGender?
  phone                 String
  email                 String?
  address               String?
  allergies             String?
  chronicConditions     String?
  currentMedications    String?
  emergencyContactName  String?
  emergencyContactPhone String?
  notes                 String?
  noShowCount           Int            @default(0)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  deletedAt             DateTime?

  clinic       Clinic         @relation(fields: [clinicId], references: [id])
  appointments Appointment[]
  visitNotes   VisitNote[]
  documents    Document[]
  invoices     Invoice[]
  notifications Notification[] @relation("NotificationPatient")

  @@index([clinicId])
  @@index([clinicId, createdAt])
}

model Service {
  id              String    @id @default(uuid())
  clinicId        String
  name            String
  description     String?
  durationMinutes Int       @default(30)
  price           Decimal   @db.Decimal(10, 2)
  color           String    @default("#3B82F6")
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  clinic       Clinic        @relation(fields: [clinicId], references: [id])
  appointments Appointment[]

  @@index([clinicId])
  @@index([clinicId, isActive])
  @@index([clinicId, name])
  @@unique([clinicId, name])
}

model OperatingHours {
  id        String    @id @default(uuid())
  clinicId  String
  dayOfWeek Int
  openTime  String
  closeTime String
  isClosed  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  clinic Clinic @relation(fields: [clinicId], references: [id])

  @@unique([clinicId, dayOfWeek])
  @@index([clinicId])
}

model Appointment {
  id                 String            @id @default(uuid())
  clinicId           String
  patientId          String
  staffId            String
  serviceId          String
  startTime          DateTime
  endTime            DateTime
  status             AppointmentStatus @default(SCHEDULED)
  cancellationReason String?
  isWalkIn           Boolean           @default(false)
  notes              String?
  source             AppointmentSource @default(ONLINE)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  deletedAt          DateTime?

  clinic        Clinic         @relation(fields: [clinicId], references: [id])
  patient       Patient        @relation(fields: [patientId], references: [id])
  staff         Staff          @relation("AppointmentStaff", fields: [staffId], references: [id])
  service       Service        @relation(fields: [serviceId], references: [id])
  visitNote     VisitNote?
  invoice       Invoice?
  notifications Notification[]

  @@index([clinicId])
  @@index([clinicId, startTime])
  @@index([clinicId, staffId, startTime])
  @@index([patientId])
  @@index([serviceId])
  @@index([status])
}

model VisitNote {
  id            String   @id @default(uuid())
  clinicId      String
  appointmentId String   @unique
  patientId     String
  staffId       String
  subjective    String?
  objective     String?
  assessment    String?
  plan          String?
  prescriptions Json?
  isAmendment   Boolean  @default(false)
  amendsNoteId  String?
  createdAt     DateTime @default(now())

  clinic      Clinic      @relation(fields: [clinicId], references: [id])
  appointment Appointment @relation(fields: [appointmentId], references: [id])
  patient     Patient     @relation(fields: [patientId], references: [id])
  staff       Staff       @relation("VisitNoteStaff", fields: [staffId], references: [id])
  amendsNote  VisitNote?  @relation("VisitNoteAmendmentChain", fields: [amendsNoteId], references: [id])
  amendments  VisitNote[] @relation("VisitNoteAmendmentChain")

  @@index([clinicId])
  @@index([patientId])
  @@index([staffId])
  @@index([amendsNoteId])
}

model Document {
  id          String           @id @default(uuid())
  clinicId    String
  patientId   String
  staffId     String
  fileName    String
  fileType    String
  fileSize    Int
  storageUrl  String
  category    DocumentCategory
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  deletedAt   DateTime?

  clinic  Clinic  @relation(fields: [clinicId], references: [id])
  patient Patient @relation(fields: [patientId], references: [id])
  staff   Staff   @relation("DocumentStaff", fields: [staffId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([staffId])
  @@index([clinicId, category])
}

model Invoice {
  id                    String         @id @default(uuid())
  clinicId              String
  patientId             String
  appointmentId         String?        @unique
  invoiceNumber         String         @unique
  status                InvoiceStatus  @default(DRAFT)
  currency              Currency
  subtotal              Decimal        @db.Decimal(12, 2)
  tax                   Decimal        @default(0) @db.Decimal(12, 2)
  total                 Decimal        @db.Decimal(12, 2)
  paidAmount            Decimal        @default(0) @db.Decimal(12, 2)
  paymentMethod         PaymentMethod?
  stripePaymentIntentId String?
  stripeCheckoutUrl     String?
  paidAt                DateTime?
  dueDate               DateTime
  sentAt                DateTime?
  notes                 String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  deletedAt             DateTime?

  clinic      Clinic        @relation(fields: [clinicId], references: [id])
  patient     Patient       @relation(fields: [patientId], references: [id])
  appointment Appointment?  @relation(fields: [appointmentId], references: [id])
  items       InvoiceItem[]

  @@index([clinicId])
  @@index([patientId])
  @@index([status])
  @@index([clinicId, status])
  @@index([clinicId, dueDate])
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Notification {
  id             String              @id @default(uuid())
  clinicId       String
  appointmentId  String?
  patientId      String?
  type           NotificationType
  channel        NotificationChannel
  recipientEmail String?
  recipientPhone String?
  status         NotificationStatus  @default(PENDING)
  sentAt         DateTime?
  errorMessage   String?
  createdAt      DateTime            @default(now())

  clinic      Clinic       @relation(fields: [clinicId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  patient     Patient?     @relation("NotificationPatient", fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([appointmentId])
  @@index([patientId])
  @@index([status])
  @@index([clinicId, type, channel])
}

model AuditLog {
  id        String      @id @default(uuid())
  clinicId  String
  userId    String
  action    AuditAction
  entity    String
  entityId  String
  changes   Json
  ipAddress String?
  userAgent String?
  createdAt DateTime    @default(now())

  clinic Clinic @relation(fields: [clinicId], references: [id])
  user   Staff  @relation("AuditLogUser", fields: [userId], references: [id])

  @@index([clinicId])
  @@index([userId])
  @@index([clinicId, createdAt])
  @@index([entity, entityId])
}
